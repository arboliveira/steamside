<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
        PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <!-- ======================================================================= -->
    <title>Test Steamside</title>

    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />


    <script src="underscore.js" type="text/javascript"></script>
    <script src="backbone.js" type="text/javascript"></script>
    <script src="jquery-1.9.1.js" type="text/javascript"></script>

    <link rel="stylesheet" href="qunit-1.11.0.css" />
    <script src="qunit-1.11.0.js" type="text/javascript"></script>

    <script type="application/javascript">

        function visibleGames(segment) {
            return segment.find('.game-tile').filter(':visible').length;
        }

        var Test_Steamside_html = Backbone.Model.extend({

            testContinues: function() {
                var segment = $('#continues-segment');

                var whenMoreButtonAppears = function () {
                    var b = segment.find('.more-button-text');
                    if (!b.is(':visible')) {
                        setTimeout(whenMoreButtonAppears, 300);
                        return;
                    }

                    equal(visibleGames(segment), 3, 'visible games before more');
                    b.click();
                    equal(visibleGames(segment), 5, 'visible games after more');

                    start();
                };
                whenMoreButtonAppears();
            },

            testSearch: function () {
                var segment = $('#search-segment');
                var input = segment.find('.search-text-input');
                input.val('anything');
                var button = segment.find('.command-button').get(0);
                button.click();
                var whenGamesAppear = function() {
                    var games = segment.find('.game-tile');
                    if (games.length == 0) {
                        setTimeout(whenGamesAppear, 300);
                        return;
                    }
                    equal(games.length, 2, 'search results');
                    start();
                };
                whenGamesAppear();
            },

            testFavorites: function () {
                var segment = $('#favorites-segment');

                var whenMoreButtonAppears = function () {
                    var b = segment.find('.more-button-text');
                    if (!b.is(':visible')) {
                        setTimeout(whenMoreButtonAppears, 300);
                        return;
                    }

                    equal(visibleGames(segment), 3, 'visible games before more');
                    b.click();
                    equal(visibleGames(segment), 5, 'visible games after more');

                    var l = segment.find("#switch-link");
                    l.click();

                    var whenDialogAppears = function() {
                        var dialog = $(":ui-dialog");
                        if (dialog.length == 0) {
                            setTimeout(whenDialogAppears, 300);
                            return;
                        }

                        var buttons = dialog.find(".collection-pick-steam-category-button");
                        equal(buttons.length, 3, 'category buttons');

                        dialog.dialog('destroy');

                        start();
                    };
                    whenDialogAppears();
                };
                whenMoreButtonAppears();
            },

            runTests: function () {
                var that = this;
                asyncTest("Continues Segment", function(){that.testContinues()});
                asyncTest("Search Segment", function(){that.testSearch()});
                asyncTest("Favorites Segment", function(){that.testFavorites()});
            },

            loadPageToTest: function () {
                var path = 'Steamside.html';
                $.ajax({url:path, success: function(page) {
                    $('#page-to-test').append($(page));
                }, dataType: 'html'});
            },

            loadAndTest: function() {
                this.loadPageToTest();
                this.runTests();
            }

        });

        $(function() {
            new Test_Steamside_html().loadAndTest();
        });

    </script>

</head>
<body>
<!-- ======================================================================= -->

<div id="qunit"></div>
<div id="qunit-fixture"></div>

<div id="page-to-test"></div>

<!-- ======================================================================= -->
</body>
</html>